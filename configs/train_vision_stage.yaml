# Vision Stage Training Configuration
# Stage 1: Train on image understanding tasks

training:
  stage: vision
  output_dir: ./checkpoints/vision_stage

  # Batch settings
  per_device_train_batch_size: 8
  gradient_accumulation_steps: 4
  effective_batch_size: 256  # 8 * 4 * 8 GPUs

  # Learning rate
  learning_rate: 1.0e-4
  lr_scheduler_type: cosine
  warmup_steps: 1000
  warmup_ratio: 0.02

  # Training duration
  max_steps: 50000
  # Alternative: num_train_epochs: 1

  # Optimizer
  optim: adamw_torch_fused
  weight_decay: 0.1
  adam_beta1: 0.9
  adam_beta2: 0.95
  adam_epsilon: 1.0e-8
  max_grad_norm: 1.0

  # Precision
  bf16: true
  tf32: true

  # Memory optimization
  gradient_checkpointing: true
  ddp_find_unused_parameters: false

  # Vision encoder freezing
  freeze_vision_encoder: true
  unfreeze_vision_after_steps: 10000

  # Checkpointing
  save_strategy: steps
  save_steps: 1000
  save_total_limit: 3
  save_on_each_node: false

  # Logging
  logging_steps: 10
  logging_first_step: true
  report_to:
    - wandb
    - tensorboard

  # Evaluation (optional)
  evaluation_strategy: steps
  eval_steps: 5000
  per_device_eval_batch_size: 16

  # Data
  dataloader_num_workers: 4
  dataloader_pin_memory: true
  remove_unused_columns: false

data:
  # Dataset weights (from paper)
  datasets:
    the_cauldron:
      path: HuggingFaceM4/the_cauldron
      weight: 0.35
      modality: image

    docmatix:
      path: HuggingFaceM4/Docmatix
      name: images
      weight: 0.41
      modality: image

  # Preprocessing
  max_length: 2048
  image_size: 384
  streaming: true

  # Data mixing
  shuffle_buffer_size: 10000
